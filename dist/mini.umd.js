!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("exifr",["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).exifr={})}(this,(function(e){"use strict";function t(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var s=i.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var i="undefined"!=typeof self?self:global;const s="undefined"!=typeof navigator,n=s&&"undefined"==typeof HTMLImageElement,r=!("undefined"==typeof global||"undefined"==typeof process||!process.versions||!process.versions.node),a=i.Buffer,h=!!a,l=e=>void 0!==e;function f(e){return void 0===e||(e instanceof Map?0===e.size:0===Object.values(e).filter(l).length)}function o(e){let t=new Error(e);throw delete t.stack,t}function u(e){let t=function(e){let t=0;return e.ifd0.enabled&&(t+=1024),e.exif.enabled&&(t+=2048),e.makerNote&&(t+=2048),e.userComment&&(t+=1024),e.gps.enabled&&(t+=512),e.interop.enabled&&(t+=100),e.ifd1.enabled&&(t+=1024),t+2048}(e);return e.jfif.enabled&&(t+=50),e.xmp.enabled&&(t+=2e4),e.iptc.enabled&&(t+=14e3),e.icc.enabled&&(t+=6e3),t}const d=e=>String.fromCharCode.apply(null,e),c="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):void 0;class g{static from(e,t){return e instanceof this&&e.le===t?e:new g(e,void 0,void 0,t)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;if("boolean"==typeof s&&(this.le=s),Array.isArray(e)&&(e=new Uint8Array(e)),0===e)this.byteOffset=0,this.byteLength=0;else if(e instanceof ArrayBuffer){void 0===i&&(i=e.byteLength-t);let s=new DataView(e,t,i);this._swapDataView(s)}else if(e instanceof Uint8Array||e instanceof DataView||e instanceof g){void 0===i&&(i=e.byteLength-t),t+=e.byteOffset,t+i>e.byteOffset+e.byteLength&&o("Creating view outside of available memory in ArrayBuffer");let s=new DataView(e.buffer,t,i);this._swapDataView(s)}else if("number"==typeof e){let t=new DataView(new ArrayBuffer(e));this._swapDataView(t)}else o("Invalid input argument for BufferView: "+e)}_swapArrayBuffer(e){this._swapDataView(new DataView(e))}_swapBuffer(e){this._swapDataView(new DataView(e.buffer,e.byteOffset,e.byteLength))}_swapDataView(e){this.dataView=e,this.buffer=e.buffer,this.byteOffset=e.byteOffset,this.byteLength=e.byteLength}_lengthToEnd(e){return this.byteLength-e}set(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:g;return e instanceof DataView||e instanceof g?e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer&&(e=new Uint8Array(e)),e instanceof Uint8Array||o("BufferView.set(): Invalid data argument."),this.toUint8().set(e,t),new i(this,t,e.byteLength)}subarray(e,t){return t=t||this._lengthToEnd(e),new g(this,e,t)}toUint8(){return new Uint8Array(this.buffer,this.byteOffset,this.byteLength)}getUint8Array(e,t){return new Uint8Array(this.buffer,this.byteOffset+e,t)}getString(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.byteLength,i=this.getUint8Array(e,t);return s=i,c?c.decode(s):h?Buffer.from(s).toString("utf8"):decodeURIComponent(escape(d(s)));var s}getLatin1String(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.byteLength,i=this.getUint8Array(e,t);return d(i)}getUnicodeString(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.byteLength;const i=[];for(let s=0;s<t&&e+s<this.byteLength;s+=2)i.push(this.getUint16(e+s));return d(i)}getInt8(e){return this.dataView.getInt8(e)}getUint8(e){return this.dataView.getUint8(e)}getInt16(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.le;return this.dataView.getInt16(e,t)}getInt32(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.le;return this.dataView.getInt32(e,t)}getUint16(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.le;return this.dataView.getUint16(e,t)}getUint32(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.le;return this.dataView.getUint32(e,t)}getFloat32(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.le;return this.dataView.getFloat32(e,t)}getFloat64(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.le;return this.dataView.getFloat64(e,t)}getFloat(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.le;return this.dataView.getFloat32(e,t)}getDouble(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.le;return this.dataView.getFloat64(e,t)}getUintBytes(e,t,i){switch(t){case 1:return this.getUint8(e,i);case 2:return this.getUint16(e,i);case 4:return this.getUint32(e,i);case 8:return this.getUint64&&this.getUint64(e,i)}}getUint(e,t,i){switch(t){case 8:return this.getUint8(e,i);case 16:return this.getUint16(e,i);case 32:return this.getUint32(e,i);case 64:return this.getUint64&&this.getUint64(e,i)}}toString(e){return this.dataView.toString(e,this.constructor.name)}ensureChunk(){}}function p(e,t){o(`${e} '${t}' was not loaded, try using full build of exifr.`)}class m extends Map{constructor(e){super(),this.kind=e}get(e,t){return this.has(e)||p(this.kind,e),t&&(e in t||function(e,t){o(`Unknown ${e} '${t}'.`)}(this.kind,e),t[e].enabled||p(this.kind,e)),super.get(e)}keyList(){return Array.from(this.keys())}}var y=new m("file parser"),b=new m("segment parser"),w=new m("file reader");let k=i.fetch;const v="Invalid input argument";function O(e,t){return(i=e).startsWith("data:")||i.length>1e4?A(e,t,"base64"):r&&e.includes("://")?S(e,t,"url",U):r?A(e,t,"fs"):s?S(e,t,"url",U):void o(v);var i}async function S(e,t,i,s){return w.has(i)?A(e,t,i):s?async function(e,t){let i=await t(e);return new g(i)}(e,s):void o(`Parser ${i} is not loaded`)}async function A(e,t,i){let s=new(w.get(i))(e,t);return await s.read(),s}const U=e=>k(e).then((e=>e.arrayBuffer())),x=e=>new Promise(((t,i)=>{let s=new FileReader;s.onloadend=()=>t(s.result||new ArrayBuffer),s.onerror=i,s.readAsArrayBuffer(e)}));class C extends Map{get tagKeys(){return this.allKeys||(this.allKeys=Array.from(this.keys())),this.allKeys}get tagValues(){return this.allValues||(this.allValues=Array.from(this.values())),this.allValues}}function B(e,t,i){let s=new C;for(let[e,t]of i)s.set(e,t);if(Array.isArray(t))for(let i of t)e.set(i,s);else e.set(t,s);return s}function V(e,t,i){let s,n=e.get(t);for(s of i)n.set(s[0],s[1])}const I=new Map,P=new Map,T=new Map,L=37500,z=37510,F=33723,j=34675,E=34665,_=34853,D=40965,M=274,N=["chunked","firstChunkSize","firstChunkSizeNode","firstChunkSizeBrowser","chunkSize","chunkLimit"],R=["jfif","xmp","icc","iptc","ihdr"],$=["tiff",...R],K=["ifd0","ifd1","exif","gps","interop"],W=[...$,...K],X=["makerNote","userComment"],H=["translateKeys","translateValues","reviveValues","multiSegment"],Y=[...H,"sanitize","mergeOutput","silentErrors"];class G{get translate(){return this.translateKeys||this.translateValues||this.reviveValues}}class J extends G{get needed(){return this.enabled||this.deps.size>0}constructor(e,i,s,n){if(super(),t(this,"enabled",!1),t(this,"skip",new Set),t(this,"pick",new Set),t(this,"deps",new Set),t(this,"translateKeys",!1),t(this,"translateValues",!1),t(this,"reviveValues",!1),this.key=e,this.enabled=i,this.parse=this.enabled,this.applyInheritables(n),this.canBeFiltered=K.includes(e),this.canBeFiltered&&(this.dict=I.get(e)),void 0!==s)if(Array.isArray(s))this.parse=this.enabled=!0,this.canBeFiltered&&s.length>0&&this.translateTagSet(s,this.pick);else if("object"==typeof s){if(this.enabled=!0,this.parse=!1!==s.parse,this.canBeFiltered){let{pick:e,skip:t}=s;e&&e.length>0&&this.translateTagSet(e,this.pick),t&&t.length>0&&this.translateTagSet(t,this.skip)}this.applyInheritables(s)}else!0===s||!1===s?this.parse=this.enabled=s:o(`Invalid options argument: ${s}`)}applyInheritables(e){let t,i;for(t of H)i=e[t],void 0!==i&&(this[t]=i)}translateTagSet(e,t){if(this.dict){let i,s,{tagKeys:n,tagValues:r}=this.dict;for(i of e)"string"==typeof i?(s=r.indexOf(i),-1===s&&(s=n.indexOf(Number(i))),-1!==s&&t.add(Number(n[s]))):t.add(i)}else for(let i of e)t.add(i)}finalizeFilters(){!this.enabled&&this.deps.size>0?(this.enabled=!0,ie(this.pick,this.deps)):this.enabled&&this.pick.size>0&&ie(this.pick,this.deps)}}var q={jfif:!1,tiff:!0,xmp:!1,icc:!1,iptc:!1,ifd0:!0,ifd1:!1,exif:!0,gps:!0,interop:!1,ihdr:void 0,makerNote:!1,userComment:!1,multiSegment:!1,skip:[],pick:[],translateKeys:!0,translateValues:!0,reviveValues:!0,sanitize:!0,mergeOutput:!0,silentErrors:!0,chunked:!0,firstChunkSize:void 0,firstChunkSizeNode:512,firstChunkSizeBrowser:65536,chunkSize:65536,chunkLimit:5},Q=new Map;class Z extends G{static useCached(e){let t=Q.get(e);return void 0!==t||(t=new this(e),Q.set(e,t)),t}constructor(e){super(),!0===e?this.setupFromTrue():void 0===e?this.setupFromUndefined():Array.isArray(e)?this.setupFromArray(e):"object"==typeof e?this.setupFromObject(e):o(`Invalid options argument ${e}`),void 0===this.firstChunkSize&&(this.firstChunkSize=s?this.firstChunkSizeBrowser:this.firstChunkSizeNode),this.mergeOutput&&(this.ifd1.enabled=!1),this.filterNestedSegmentTags(),this.traverseTiffDependencyTree(),this.checkLoadedPlugins()}setupFromUndefined(){let e;for(e of N)this[e]=q[e];for(e of Y)this[e]=q[e];for(e of X)this[e]=q[e];for(e of W)this[e]=new J(e,q[e],void 0,this)}setupFromTrue(){let e;for(e of N)this[e]=q[e];for(e of Y)this[e]=q[e];for(e of X)this[e]=!0;for(e of W)this[e]=new J(e,!0,void 0,this)}setupFromArray(e){let t;for(t of N)this[t]=q[t];for(t of Y)this[t]=q[t];for(t of X)this[t]=q[t];for(t of W)this[t]=new J(t,!1,void 0,this);this.setupGlobalFilters(e,void 0,K)}setupFromObject(e){let t;for(t of(K.ifd0=K.ifd0||K.image,K.ifd1=K.ifd1||K.thumbnail,Object.assign(this,e),N))this[t]=te(e[t],q[t]);for(t of Y)this[t]=te(e[t],q[t]);for(t of X)this[t]=te(e[t],q[t]);for(t of $)this[t]=new J(t,q[t],e[t],this);for(t of K)this[t]=new J(t,q[t],e[t],this.tiff);this.setupGlobalFilters(e.pick,e.skip,K,W),!0===e.tiff?this.batchEnableWithBool(K,!0):!1===e.tiff?this.batchEnableWithUserValue(K,e):Array.isArray(e.tiff)?this.setupGlobalFilters(e.tiff,void 0,K):"object"==typeof e.tiff&&this.setupGlobalFilters(e.tiff.pick,e.tiff.skip,K)}batchEnableWithBool(e,t){for(let i of e)this[i].enabled=t}batchEnableWithUserValue(e,t){for(let i of e){let e=t[i];this[i].enabled=!1!==e&&void 0!==e}}setupGlobalFilters(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i;if(e&&e.length){for(let e of s)this[e].enabled=!1;let t=ee(e,i);for(let[e,i]of t)ie(this[e].pick,i),this[e].enabled=!0}else if(t&&t.length){let e=ee(t,i);for(let[t,i]of e)ie(this[t].skip,i)}}filterNestedSegmentTags(){let{ifd0:e,exif:t,xmp:i,iptc:s,icc:n}=this;this.makerNote?t.deps.add(L):t.skip.add(L),this.userComment?t.deps.add(z):t.skip.add(z),i.enabled||e.skip.add(700),s.enabled||e.skip.add(F),n.enabled||e.skip.add(j)}traverseTiffDependencyTree(){let{ifd0:e,exif:t,gps:i,interop:s}=this;s.needed&&(t.deps.add(D),e.deps.add(D)),t.needed&&e.deps.add(E),i.needed&&e.deps.add(_),this.tiff.enabled=K.some((e=>!0===this[e].enabled))||this.makerNote||this.userComment;for(let e of K)this[e].finalizeFilters()}get onlyTiff(){return!R.map((e=>this[e].enabled)).some((e=>!0===e))&&this.tiff.enabled}checkLoadedPlugins(){for(let e of $)this[e].enabled&&!b.has(e)&&p("segment parser",e)}}function ee(e,t){let i,s,n,r,a=[];for(n of t){for(r of(i=I.get(n),s=[],i))(e.includes(r[0])||e.includes(r[1]))&&s.push(r[0]);s.length&&a.push([n,s])}return a}function te(e,t){return void 0!==e?e:void 0!==t?t:void 0}function ie(e,t){for(let i of t)e.add(i)}t(Z,"default",q);class se{constructor(e){t(this,"parsers",{}),t(this,"output",{}),t(this,"errors",[]),t(this,"pushToErrors",(e=>this.errors.push(e))),this.options=Z.useCached(e)}async read(e){this.file=await function(e,t){return"string"==typeof e?O(e,t):s&&!n&&e instanceof HTMLImageElement?O(e.src,t):e instanceof Uint8Array||e instanceof ArrayBuffer||e instanceof DataView?new g(e):s&&e instanceof Blob?S(e,t,"blob",x):void o(v)}(e,this.options)}setup(){if(this.fileParser)return;let{file:e}=this,t=e.getUint16(0);for(let[i,s]of y)if(s.canHandle(e,t))return this.fileParser=new s(this.options,this.file,this.parsers),e[i]=!0;this.file.close&&this.file.close(),o("Unknown file format")}async parse(){let{output:e,errors:t}=this;return this.setup(),this.options.silentErrors?(await this.executeParsers().catch(this.pushToErrors),t.push(...this.fileParser.errors)):await this.executeParsers(),this.file.close&&this.file.close(),this.options.silentErrors&&t.length>0&&(e.errors=t),f(i=e)?void 0:i;var i}async executeParsers(){let{output:e}=this;await this.fileParser.parse();let t=Object.values(this.parsers).map((async t=>{let i=await t.parse();t.assignToOutput(e,i)}));this.options.silentErrors&&(t=t.map((e=>e.catch(this.pushToErrors)))),await Promise.all(t)}async extractThumbnail(){this.setup();let{options:e,file:t}=this,i=b.get("tiff",e);var s;if(t.tiff?s={start:0,type:"tiff"}:t.jpeg&&(s=await this.fileParser.getOrFindSegment("tiff")),void 0===s)return;let n=await this.fileParser.ensureSegmentChunk(s),r=this.parsers.tiff=new i(n,e,t),a=await r.extractThumbnail();return t.close&&t.close(),a}}async function ne(e,t){let i=new se(t);return await i.read(e),i.parse()}var re=Object.freeze({__proto__:null,Exifr:se,Options:Z,allFormatters:Y,chunkedProps:N,createDictionary:B,extendDictionary:V,fetchUrlAsArrayBuffer:U,fileParsers:y,fileReaders:w,inheritables:H,otherSegments:R,parse:ne,readBlobAsArrayBuffer:x,segmentParsers:b,segments:$,segmentsAndBlocks:W,tagKeys:I,tagRevivers:T,tagValues:P,tiffBlocks:K,tiffExtractables:X});class ae{constructor(e,i,s){t(this,"errors",[]),t(this,"ensureSegmentChunk",(async e=>{let t=e.start,i=e.size||65536;if(this.file.chunked)if(this.file.available(t,i))e.chunk=this.file.subarray(t,i);else try{e.chunk=await this.file.readChunk(t,i)}catch(t){o(`Couldn't read segment: ${JSON.stringify(e)}. ${t.message}`)}else this.file.byteLength>t+i?e.chunk=this.file.subarray(t,i):void 0===e.size?e.chunk=this.file.subarray(t):o("Segment unreachable: "+JSON.stringify(e));return e.chunk})),this.extendOptions&&this.extendOptions(e),this.options=e,this.file=i,this.parsers=s}injectSegment(e,t){this.options[e].enabled&&this.createParser(e,t)}createParser(e,t){let i=new(b.get(e))(t,this.options,this.file);return this.parsers[e]=i}createParsers(e){for(let t of e){let{type:e,chunk:i}=t,s=this.options[e];if(s&&s.enabled){let t=this.parsers[e];t&&t.append||t||this.createParser(e,i)}}}async readSegments(e){let t=e.map(this.ensureSegmentChunk);await Promise.all(t)}}class he{static findPosition(e,t){let i=e.getUint16(t+2)+2,s="function"==typeof this.headerLength?this.headerLength(e,t,i):this.headerLength,n=t+s,r=i-s;return{offset:t,length:i,headerLength:s,start:n,size:r,end:n+r}}static parse(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new this(e,new Z({[this.type]:t}),e).parse()}normalizeInput(e){return e instanceof g?e:new g(e)}constructor(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0;t(this,"errors",[]),t(this,"raw",new Map),t(this,"handleError",(e=>{if(!this.options.silentErrors)throw e;this.errors.push(e.message)})),this.chunk=this.normalizeInput(e),this.file=s,this.type=this.constructor.type,this.globalOptions=this.options=i,this.localOptions=i[this.type],this.canTranslate=this.localOptions&&this.localOptions.translate}translate(){this.canTranslate&&(this.translated=this.translateBlock(this.raw,this.type))}get output(){return this.translated?this.translated:this.raw?Object.fromEntries(this.raw):void 0}translateBlock(e,t){let i=T.get(t),s=P.get(t),n=I.get(t),r=this.options[t],a=r.reviveValues&&!!i,h=r.translateValues&&!!s,l=r.translateKeys&&!!n,f={};for(let[t,r]of e)a&&i.has(t)?r=i.get(t)(r):h&&s.has(t)&&(r=this.translateValue(r,s.get(t))),l&&n.has(t)&&(t=n.get(t)||t),f[t]=r;return f}translateValue(e,t){return t[e]||t.DEFAULT||e}assignToOutput(e,t){this.assignObjectToOutput(e,this.constructor.type,t)}assignObjectToOutput(e,t,i){if(this.globalOptions.mergeOutput)return Object.assign(e,i);e[t]?Object.assign(e[t],i):e[t]=i}}t(he,"headerLength",4),t(he,"type",void 0),t(he,"multiSegment",!1),t(he,"canHandle",(()=>!1));const le=224,fe=239,oe=192,ue=194,de=196,ce=219,ge=221,pe=218,me=254;function ye(e){return e===oe||e===ue||e===de||e===ce||e===ge||e===pe||e===me}function be(e){return e>=le&&e<=fe}function we(e,t,i){for(let[s,n]of b)if(n.canHandle(e,t,i))return s}class ke extends ae{constructor(){super(...arguments),t(this,"appSegments",[]),t(this,"jpegSegments",[]),t(this,"unknownSegments",[])}static canHandle(e,t){return 65496===t}async parse(){await this.findAppSegments(),await this.readSegments(this.appSegments),this.mergeMultiSegments(),this.createParsers(this.mergedAppSegments||this.appSegments)}setupSegmentFinderArgs(e){!0===e?(this.findAll=!0,this.wanted=new Set(b.keyList())):(e=void 0===e?b.keyList().filter((e=>this.options[e].enabled)):e.filter((e=>this.options[e].enabled&&b.has(e))),this.findAll=!1,this.remaining=new Set(e),this.wanted=new Set(e)),this.unfinishedMultiSegment=!1}async findAppSegments(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;this.setupSegmentFinderArgs(t);let{file:i,findAll:s,wanted:n,remaining:r}=this;if(!s&&this.file.chunked&&(s=Array.from(n).some((e=>{let t=b.get(e),i=this.options[e];return t.multiSegment&&i.multiSegment})),s&&await this.file.readWhole()),e=this.findAppSegmentsInRange(e,i.byteLength),!this.options.onlyTiff&&i.chunked){let t=!1;for(;r.size>0&&!t&&(i.canReadNextChunk||this.unfinishedMultiSegment);){let{nextChunkOffset:s}=i,n=this.appSegments.some((e=>!this.file.available(e.offset||e.start,e.length||e.size)));if(t=e>s&&!n?!await i.readNextChunk(e):!await i.readNextChunk(s),e=this.findAppSegmentsInRange(e,i.byteLength),void 0===e)return}}}findAppSegmentsInRange(e,t){t-=2;let i,s,n,r,a,h,{file:l,findAll:f,wanted:o,remaining:u,options:d}=this;for(;e<t;e++)if(255===l.getUint8(e))if(i=l.getUint8(e+1),be(i)){if(s=l.getUint16(e+2),n=we(l,e,s),n&&o.has(n)&&(r=b.get(n),a=r.findPosition(l,e),h=d[n],a.type=n,this.appSegments.push(a),!f&&(r.multiSegment&&h.multiSegment?(this.unfinishedMultiSegment=a.chunkNumber<a.chunkCount,this.unfinishedMultiSegment||u.delete(n)):u.delete(n),0===u.size)))break;d.recordUnknownSegments&&(a=he.findPosition(l,e),a.marker=i,this.unknownSegments.push(a)),e+=s+1}else if(ye(i)){if(s=l.getUint16(e+2),i===pe&&!1!==d.stopAfterSos)return;d.recordJpegSegments&&this.jpegSegments.push({offset:e,length:s,marker:i}),e+=s+1}return e}mergeMultiSegments(){if(!this.appSegments.some((e=>e.multiSegment)))return;let e=function(e,t){let i,s,n,r=new Map;for(let a=0;a<e.length;a++)i=e[a],s=i[t],r.has(s)?n=r.get(s):r.set(s,n=[]),n.push(i);return Array.from(r)}(this.appSegments,"type");this.mergedAppSegments=e.map((e=>{let[t,i]=e,s=b.get(t,this.options);if(s.handleMultiSegments){return{type:t,chunk:s.handleMultiSegments(i)}}return i[0]}))}getSegment(e){return this.appSegments.find((t=>t.type===e))}async getOrFindSegment(e){let t=this.getSegment(e);return void 0===t&&(await this.findAppSegments(0,[e]),t=this.getSegment(e)),t}}t(ke,"type","jpeg"),y.set("jpeg",ke);const ve=1,Oe=3,Se=4,Ae=5,Ue=6,xe=8,Ce=9,Be=10,Ve=11,Ie=12,Pe=[void 0,1,1,2,4,8,1,1,2,4,8,4,8,4];class Te extends he{parseHeader(){var e=this.chunk.getUint16();18761===e?this.le=!0:19789===e&&(this.le=!1),this.chunk.le=this.le,this.headerParsed=!0}parseTags(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Map,{pick:s,skip:n}=this.options[t];s=new Set(s);let r=s.size>0,a=0===n.size,h=this.chunk.getUint16(e);e+=2;for(let l=0;l<h;l++){let h=this.chunk.getUint16(e);if(r){if(s.has(h)&&(i.set(h,this.parseTag(e,h,t)),s.delete(h),0===s.size))break}else!a&&n.has(h)||i.set(h,this.parseTag(e,h,t));e+=12}return i}parseTag(e,t,i){let{chunk:s}=this,n=s.getUint16(e+2),r=s.getUint32(e+4),a=Pe[n];if(a*r<=4?e+=8:e=s.getUint32(e+8),(n<ve||n>13)&&o(`Invalid TIFF value type. block: ${i.toUpperCase()}, tag: ${t.toString(16)}, type: ${n}, offset ${e}`),e>s.byteLength&&o(`Invalid TIFF value offset. block: ${i.toUpperCase()}, tag: ${t.toString(16)}, type: ${n}, offset ${e} is outside of chunk size ${s.byteLength}`),n===ve)return s.getUint8Array(e,r);if(2===n)return""===(h=function(e){for(;e.endsWith("\0");)e=e.slice(0,-1);return e}(h=s.getString(e,r)).trim())?void 0:h;var h;if(7===n)return s.getUint8Array(e,r);if(1===r)return this.parseTagValue(n,e);{let t=function(e){switch(e){case ve:return Uint8Array;case Oe:return Uint16Array;case Se:return Uint32Array;case Ae:return Array;case Ue:return Int8Array;case xe:return Int16Array;case Ce:return Int32Array;case Be:return Array;case Ve:return Float32Array;case Ie:return Float64Array;default:return Array}}(n),i=new t(r),s=a;for(let t=0;t<r;t++)i[t]=this.parseTagValue(n,e),e+=s;return i}}parseTagValue(e,t){let{chunk:i}=this;switch(e){case ve:return i.getUint8(t);case Oe:return i.getUint16(t);case Se:return i.getUint32(t);case Ae:return i.getUint32(t)/i.getUint32(t+4);case Ue:return i.getInt8(t);case xe:return i.getInt16(t);case Ce:return i.getInt32(t);case Be:return i.getInt32(t)/i.getInt32(t+4);case Ve:return i.getFloat(t);case Ie:return i.getDouble(t);case 13:return i.getUint32(t);default:o(`Invalid tiff type ${e}`)}}}class Le extends Te{static canHandle(e,t){return 225===e.getUint8(t+1)&&1165519206===e.getUint32(t+4)&&0===e.getUint16(t+8)}async parse(){this.parseHeader();let{options:e}=this;return e.ifd0.enabled&&await this.parseIfd0Block(),e.exif.enabled&&await this.safeParse("parseExifBlock"),e.gps.enabled&&await this.safeParse("parseGpsBlock"),e.interop.enabled&&await this.safeParse("parseInteropBlock"),e.ifd1.enabled&&await this.safeParse("parseThumbnailBlock"),this.createOutput()}safeParse(e){let t=this[e]();return void 0!==t.catch&&(t=t.catch(this.handleError)),t}findIfd0Offset(){void 0===this.ifd0Offset&&(this.ifd0Offset=this.chunk.getUint32(4))}findIfd1Offset(){if(void 0===this.ifd1Offset){this.findIfd0Offset();let e=this.chunk.getUint16(this.ifd0Offset),t=this.ifd0Offset+2+12*e;this.ifd1Offset=this.chunk.getUint32(t)}}parseBlock(e,t){let i=new Map;return this[t]=i,this.parseTags(e,t,i),i}async parseIfd0Block(){if(this.ifd0)return;let{file:e}=this;this.findIfd0Offset(),this.ifd0Offset<8&&o("Malformed EXIF data"),!e.chunked&&this.ifd0Offset>e.byteLength&&o(`IFD0 offset points to outside of file.\nthis.ifd0Offset: ${this.ifd0Offset}, file.byteLength: ${e.byteLength}`),e.tiff&&await e.ensureChunk(this.ifd0Offset,u(this.options));let t=this.parseBlock(this.ifd0Offset,"ifd0");return 0!==t.size?(this.exifOffset=t.get(E),this.interopOffset=t.get(D),this.gpsOffset=t.get(_),this.xmp=t.get(700),this.iptc=t.get(F),this.icc=t.get(j),this.options.sanitize&&(t.delete(E),t.delete(D),t.delete(_),t.delete(700),t.delete(F),t.delete(j)),t):void 0}async parseExifBlock(){if(this.exif)return;if(this.ifd0||await this.parseIfd0Block(),void 0===this.exifOffset)return;this.file.tiff&&await this.file.ensureChunk(this.exifOffset,u(this.options));let e=this.parseBlock(this.exifOffset,"exif");return this.interopOffset||(this.interopOffset=e.get(D)),this.makerNote=e.get(L),this.userComment=e.get(z),this.options.sanitize&&(e.delete(D),e.delete(L),e.delete(z)),this.unpack(e,41728),this.unpack(e,41729),e}unpack(e,t){let i=e.get(t);i&&1===i.length&&e.set(t,i[0])}async parseGpsBlock(){if(this.gps)return;if(this.ifd0||await this.parseIfd0Block(),void 0===this.gpsOffset)return;let e=this.parseBlock(this.gpsOffset,"gps");return e&&e.has(2)&&e.has(4)&&(e.set("latitude",ze(...e.get(2),e.get(1))),e.set("longitude",ze(...e.get(4),e.get(3)))),e}async parseInteropBlock(){if(!this.interop&&(this.ifd0||await this.parseIfd0Block(),void 0!==this.interopOffset||this.exif||await this.parseExifBlock(),void 0!==this.interopOffset))return this.parseBlock(this.interopOffset,"interop")}async parseThumbnailBlock(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.ifd1&&!this.ifd1Parsed&&(!this.options.mergeOutput||e))return this.findIfd1Offset(),this.ifd1Offset>0&&(this.parseBlock(this.ifd1Offset,"ifd1"),this.ifd1Parsed=!0),this.ifd1}async extractThumbnail(){if(this.headerParsed||this.parseHeader(),this.ifd1Parsed||await this.parseThumbnailBlock(!0),void 0===this.ifd1)return;let e=this.ifd1.get(513),t=this.ifd1.get(514);return this.chunk.getUint8Array(e,t)}get image(){return this.ifd0}get thumbnail(){return this.ifd1}createOutput(){let e,t,i,s={};for(t of K)if(e=this[t],!f(e))if(i=this.canTranslate?this.translateBlock(e,t):Object.fromEntries(e),this.options.mergeOutput){if("ifd1"===t)continue;Object.assign(s,i)}else s[t]=i;return this.makerNote&&(s.makerNote=this.makerNote),this.userComment&&(s.userComment=this.userComment),s}assignToOutput(e,t){if(this.globalOptions.mergeOutput)Object.assign(e,t);else for(let[i,s]of Object.entries(t))this.assignObjectToOutput(e,i,s)}}function ze(e,t,i,s){var n=e+t/60+i/3600;return"S"!==s&&"W"!==s||(n*=-1),n}t(Le,"type","tiff"),t(Le,"headerLength",10),b.set("tiff",Le);var Fe=Object.freeze({__proto__:null,Exifr:se,Options:Z,allFormatters:Y,chunkedProps:N,createDictionary:B,default:re,extendDictionary:V,fetchUrlAsArrayBuffer:U,fileParsers:y,fileReaders:w,inheritables:H,otherSegments:R,parse:ne,readBlobAsArrayBuffer:x,segmentParsers:b,segments:$,segmentsAndBlocks:W,tagKeys:I,tagRevivers:T,tagValues:P,tiffBlocks:K,tiffExtractables:X});const je={ifd0:!1,ifd1:!1,exif:!1,gps:!1,interop:!1,sanitize:!1,reviveValues:!0,translateKeys:!1,translateValues:!1,mergeOutput:!1},Ee=Object.assign({},je,{firstChunkSize:4e4,gps:[1,2,3,4]});const _e=Object.assign({},je,{tiff:!1,ifd1:!0,mergeOutput:!1});const De=Object.assign({},je,{firstChunkSize:4e4,ifd0:[M]});async function Me(e){let t=new se(De);await t.read(e);let i=await t.parse();if(i&&i.ifd0)return i.ifd0[M]}const Ne=Object.freeze({1:{dimensionSwapped:!1,scaleX:1,scaleY:1,deg:0,rad:0},2:{dimensionSwapped:!1,scaleX:-1,scaleY:1,deg:0,rad:0},3:{dimensionSwapped:!1,scaleX:1,scaleY:1,deg:180,rad:180*Math.PI/180},4:{dimensionSwapped:!1,scaleX:-1,scaleY:1,deg:180,rad:180*Math.PI/180},5:{dimensionSwapped:!0,scaleX:1,scaleY:-1,deg:90,rad:90*Math.PI/180},6:{dimensionSwapped:!0,scaleX:1,scaleY:1,deg:90,rad:90*Math.PI/180},7:{dimensionSwapped:!0,scaleX:1,scaleY:-1,deg:270,rad:270*Math.PI/180},8:{dimensionSwapped:!0,scaleX:1,scaleY:1,deg:270,rad:270*Math.PI/180}});if(e.rotateCanvas=!0,e.rotateCss=!0,"object"==typeof navigator){let t=navigator.userAgent;if(t.includes("iPad")||t.includes("iPhone")){let i=t.match(/OS (\d+)_(\d+)/);if(i){let[,t,s]=i,n=Number(t)+.1*Number(s);e.rotateCanvas=n<13.4,e.rotateCss=!1}}else if(t.includes("OS X 10")){let[,i]=t.match(/OS X 10[_.](\d+)/);e.rotateCanvas=e.rotateCss=Number(i)<15}if(t.includes("Chrome/")){let[,i]=t.match(/Chrome\/(\d+)/);e.rotateCanvas=e.rotateCss=Number(i)<81}else if(t.includes("Firefox/")){let[,i]=t.match(/Firefox\/(\d+)/);e.rotateCanvas=e.rotateCss=Number(i)<77}}class Re extends g{constructor(){super(...arguments),t(this,"ranges",new $e),0!==this.byteLength&&this.ranges.add(0,this.byteLength)}_tryExtend(e,t,i){if(0===e&&0===this.byteLength&&i){let e=new DataView(i.buffer||i,i.byteOffset,i.byteLength);this._swapDataView(e)}else{let i=e+t;if(i>this.byteLength){let{dataView:e}=this._extend(i);this._swapDataView(e)}}}_extend(e){let t;t=h?a.allocUnsafe(e):new Uint8Array(e);let i=new DataView(t.buffer,t.byteOffset,t.byteLength);return t.set(new Uint8Array(this.buffer,this.byteOffset,this.byteLength),0),{uintView:t,dataView:i}}subarray(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t=t||this._lengthToEnd(e),i&&this._tryExtend(e,t),this.ranges.add(e,t),super.subarray(e,t)}set(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2]&&this._tryExtend(t,e.byteLength,e);let i=super.set(e,t);return this.ranges.add(t,i.byteLength),i}async ensureChunk(e,t){this.chunked&&(this.ranges.available(e,t)||await this.readChunk(e,t))}available(e,t){return this.ranges.available(e,t)}}class $e{constructor(){t(this,"list",[])}get length(){return this.list.length}add(e,t){let i=e+t,s=this.list.filter((t=>Ke(e,t.offset,i)||Ke(e,t.end,i)));if(s.length>0){e=Math.min(e,...s.map((e=>e.offset))),i=Math.max(i,...s.map((e=>e.end))),t=i-e;let n=s.shift();n.offset=e,n.length=t,n.end=i,this.list=this.list.filter((e=>!s.includes(e)))}else this.list.push({offset:e,length:t,end:i})}available(e,t){let i=e+t;return this.list.some((t=>t.offset<=e&&i<=t.end))}}function Ke(e,t,i){return e<=t&&t<=i}class We extends Re{constructor(e,i){super(0),t(this,"chunksRead",0),this.input=e,this.options=i}async readWhole(){this.chunked=!1,await this.readChunk(this.nextChunkOffset)}async readChunked(){this.chunked=!0,await this.readChunk(0,this.options.firstChunkSize)}async readNextChunk(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.nextChunkOffset;if(this.fullyRead)return this.chunksRead++,!1;let t=this.options.chunkSize,i=await this.readChunk(e,t);return!!i&&i.byteLength===t}async readChunk(e,t){if(this.chunksRead++,0!==(t=this.safeWrapAddress(e,t)))return this._readChunk(e,t)}safeWrapAddress(e,t){return void 0!==this.size&&e+t>this.size?Math.max(0,this.size-e):t}get nextChunkOffset(){if(0!==this.ranges.list.length)return this.ranges.list[0].length}get canReadNextChunk(){return this.chunksRead<this.options.chunkLimit}get fullyRead(){return void 0!==this.size&&this.nextChunkOffset===this.size}read(){return this.options.chunked?this.readChunked():this.readWhole()}close(){}}w.set("blob",class extends We{async readWhole(){this.chunked=!1;let e=await x(this.input);this._swapArrayBuffer(e)}readChunked(){return this.chunked=!0,this.size=this.input.size,super.readChunked()}async _readChunk(e,t){let i=t?e+t:void 0,s=this.input.slice(e,i),n=await x(s);return this.set(n,e,!0)}}),e.Exifr=se,e.Options=Z,e.allFormatters=Y,e.chunkedProps=N,e.createDictionary=B,e.default=Fe,e.extendDictionary=V,e.fetchUrlAsArrayBuffer=U,e.fileParsers=y,e.fileReaders=w,e.gps=async function(e){let t=new se(Ee);await t.read(e);let i=await t.parse();if(i&&i.gps){let{latitude:e,longitude:t}=i.gps;return{latitude:e,longitude:t}}},e.gpsOnlyOptions=Ee,e.inheritables=H,e.orientation=Me,e.orientationOnlyOptions=De,e.otherSegments=R,e.parse=ne,e.readBlobAsArrayBuffer=x,e.rotation=async function(t){let i=await Me(t);return Object.assign({canvas:e.rotateCanvas,css:e.rotateCss},Ne[i])},e.rotations=Ne,e.segmentParsers=b,e.segments=$,e.segmentsAndBlocks=W,e.tagKeys=I,e.tagRevivers=T,e.tagValues=P,e.thumbnail=async function(e){let t=new se(_e);await t.read(e);let i=await t.extractThumbnail();return i&&h?a.from(i):i},e.thumbnailOnlyOptions=_e,e.thumbnailUrl=async function(e){let t=await this.thumbnail(e);if(void 0!==t){let e=new Blob([t]);return URL.createObjectURL(e)}},e.tiffBlocks=K,e.tiffExtractables=X,Object.defineProperty(e,"__esModule",{value:!0})}));
